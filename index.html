<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODPEN COFFEE - Official Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sb-green: #00704A; }
        .bg-starbucks { background-color: var(--sb-green); }
        .text-starbucks { color: var(--sb-green); }
        .menu-category { border-left: 4px solid var(--sb-green); padding-left: 10px; margin-top: 20px; font-weight: 800; color: var(--sb-green); }
        .menu-item { border-bottom: 1px solid #eee; padding: 12px 0; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-starbucks text-white p-4 sticky top-0 z-50 shadow-lg text-center font-bold tracking-widest">
        KODPEN COFFEE
    </nav>

    <div class="container mx-auto px-4 py-6 max-w-md">
        <div class="text-center mb-8">
            <img src="logo_kodpen.png" alt="Logo" class="mx-auto w-24 mb-2" onerror="this.src='https://via.placeholder.com/100?text=KODPEN'">
            <h2 class="text-xl font-black text-starbucks italic italic uppercase tracking-tighter">"So Ba Kopi Bro?"</h2>
        </div>

        <div class="mb-4 rounded-xl shadow-lg border-4 border-starbucks overflow-hidden bg-white">
            <img src="ThisOurMenu.jpg" alt="Menu" class="w-full">
        </div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <label class="block font-bold mb-2">Pilih Nomor Meja:</label>
            <select id="nomorMeja" class="w-full p-3 border rounded-lg outline-none">
                <option value="">-- Pilih Meja --</option>
            </select>
        </div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <label class="block font-bold mb-2 border-b pb-2 uppercase text-xs tracking-widest text-gray-400">Daftar Menu:</label>
            <div class="menu-category uppercase text-xs">Iced Coffee</div>
            <div id="list-iced"></div>
            <div class="menu-category uppercase text-xs">Non Coffee</div>
            <div id="list-non"></div>
            <div class="menu-category uppercase text-xs">Manual Brew</div>
            <div id="list-manual"></div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <label class="block font-bold mb-4">Metode Pembayaran:</label>
            <div class="space-y-2 mb-4">
                <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                    <input type="radio" name="payment" value="Transfer BNI" onchange="valBtn()" class="mr-3"> Transfer BNI
                </label>
                <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                    <input type="radio" name="payment" value="QRIS" onchange="valBtn()" class="mr-3"> QRIS (Barcode)
                </label>
                <label class="flex items-center p-3 border rounded-lg cursor-pointer">
                    <input type="radio" name="payment" value="Tunai" onchange="valBtn()" class="mr-3" checked> Tunai (Kasir)
                </label>
            </div>

            <div id="uploadArea" class="hidden p-4 bg-gray-50 rounded-lg border-2 border-dashed">
                <p class="text-[10px] font-bold text-red-600 mb-2 uppercase">Wajib Upload Bukti Bayar!</p>
                <input type="file" id="buktiFile" accept="image/*" onchange="valBtn()" class="text-xs mb-3 w-full">
                
                <div id="qrisBox" class="hidden text-center border-t pt-3">
                    <img src="Barcode.png" class="w-32 mx-auto mb-2 rounded shadow">
                    <a href="Barcode.png" download="QRIS_KODPEN_COFFEE.png" class="text-blue-600 text-[10px] font-bold underline">
                        <i class="fas fa-download mr-1"></i> DOWNLOAD BARCODE QRIS
                    </a>
                </div>
                <div id="bniBox" class="hidden text-[10px] font-mono text-center">
                    BNI: 0388924011<br>a.n FAZRIN HARUN
                </div>
            </div>
        </div>

        <div class="text-center py-6 bg-white rounded-xl shadow-2xl px-4">
            <div class="text-xl font-bold mb-4">Total: <span id="totalHarga" class="text-starbucks text-2xl">Rp 0</span></div>
            <button id="btnPesan" onclick="kirimPesanan()" class="w-full bg-starbucks text-white font-bold py-4 rounded-full shadow-xl active:scale-95 transition">
                PESAN SEKARANG
            </button>
            <button id="btnMyBill" onclick="unduhStruk()" class="hidden w-full mt-4 bg-blue-600 text-white font-bold py-4 rounded-full shadow-xl">
                MY BILL (UNDUH NOTA)
            </button>
        </div>
    </div>

    <div class="receipt-hidden"><div id="receipt-area"></div></div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbw_MnZKTEsDElIQBelVOsIStadB-mipRSUnp3BvxYQIHB3j6-kixV8agFJ7zcz7walFWQ/exec';
        const menuData = {
            iced: [{n:"Street Coffee", h:15000}, {n:"Americano", h:15000}, {n:"ButterStreet", h:20000}, {n:"Aren Royale", h:20000}, {n:"Pop Rock", h:20000}],
            non: [{n:"Chocolate", h:18000}, {n:"Matcha", h:18000}, {n:"Red Velvet", h:18000}],
            manual: [{n:"Hot Coffee Milk", h:13000}]
        };

        let keranjang = {};
        let lastOrder = {};

        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('nomorMeja');
            for(let i=1; i<=20; i++) sel.innerHTML += `<option value="${i}">Meja ${i}</option>`;
            Object.keys(menuData).forEach(cat => {
                const cont = document.getElementById('list-' + cat);
                menuData[cat].forEach(item => {
                    const id = item.n.replace(/\s+/g, '');
                    cont.innerHTML += `
                        <div class="menu-item flex justify-between items-center px-1">
                            <div><p class="font-bold text-sm">${item.n}</p><p class="text-xs text-gray-400">Rp ${item.h.toLocaleString()}</p></div>
                            <div class="flex items-center gap-3">
                                <button onclick="qty('${item.n}',${item.h},-1)" class="w-7 h-7 rounded-full bg-gray-100 font-bold">-</button>
                                <span id="q-${id}" class="font-bold text-sm">0</span>
                                <button onclick="qty('${item.n}',${item.h},1)" class="w-7 h-7 rounded-full bg-starbucks text-white font-bold">+</button>
                            </div>
                        </div>`;
                });
            });
            valBtn();
        });

        function qty(n, h, c) {
            if(!keranjang[n]) keranjang[n] = { q:0, h:h };
            keranjang[n].q += c; if(keranjang[n].q < 0) keranjang[n].q = 0;
            document.getElementById('q-'+n.replace(/\s+/g, '')).innerText = keranjang[n].q;
            let total = 0; Object.values(keranjang).forEach(v => total += (v.q * v.h));
            document.getElementById('totalHarga').innerText = "Rp " + total.toLocaleString('id-ID');
            valBtn();
        }

        function valBtn() {
            const pay = document.querySelector('input[name="payment"]:checked').value;
            const upArea = document.getElementById('uploadArea');
            const file = document.getElementById('buktiFile');
            const btn = document.getElementById('btnPesan');
            
            if(pay === 'Tunai') {
                upArea.classList.add('hidden');
                btn.disabled = false; btn.classList.remove('opacity-50');
            } else {
                upArea.classList.remove('hidden');
                document.getElementById('qrisBox').classList.toggle('hidden', pay !== 'QRIS');
                document.getElementById('bniBox').classList.toggle('hidden', pay !== 'Transfer BNI');
                if(file.files.length === 0) {
                    btn.disabled = true; btn.classList.add('opacity-50');
                } else {
                    btn.disabled = false; btn.classList.remove('opacity-50');
                }
            }
        }

        async function kirimPesanan() {
            const meja = document.getElementById('nomorMeja').value;
            const fileInput = document.getElementById('buktiFile');
            let det = ""; Object.keys(keranjang).forEach(k => { if(keranjang[k].q > 0) det += `${k} (${keranjang[k].q}x), `; });
            
            if(!meja || !det) return alert("Pilih Meja & Menu!");

            const btn = document.getElementById('btnPesan');
            btn.innerText = "MENGIRIM..."; btn.disabled = true;

            let fileB64 = ""; let fName = "";
            if(fileInput.files.length > 0) {
                fName = fileInput.files[0].name;
                fileB64 = await new Promise(r => { 
                    const reader = new FileReader(); reader.onload = () => r(reader.result); reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const payload = {
                meja, pesanan: det.slice(0,-2), pembayaran: document.querySelector('input[name="payment"]:checked').value,
                total: document.getElementById('totalHarga').innerText, fileBase64: fileB64, fileName: fName
            };

            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => {
                alert("PESANAN BERHASIL!");
                lastOrder = payload; btn.classList.add('hidden'); document.getElementById('btnMyBill').classList.remove('hidden');
            }).catch(() => alert("Koneksi Gagal!"));
        }

        function unduhStruk() {
            const area = document.getElementById('receipt-area');
            area.style.cssText = "width:58mm; padding:10px; background:white; color:black; font-family:monospace; font-size:10px;";
            area.innerHTML = `<div style="text-align:center"><strong>KODPEN COFFEE</strong><br>MEJA ${lastOrder.meja}<br><hr>${lastOrder.pesanan}<br><hr>Total: ${lastOrder.total}<br>Pay: ${lastOrder.pembayaran}</div>`;
            html2canvas(area, {scale:2}).then(c => {
                const a = document.createElement('a'); a.download = 'Nota_Kodpen.png'; a.href = c.toDataURL(); a.click();
            });
        }
    </script>
</body>
</html>
